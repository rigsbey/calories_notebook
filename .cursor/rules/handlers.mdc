---
globs: handlers.py,commands.py
---

# Обработчики сообщений

## FSM состояния:
- FoodAnalysisStates.waiting_for_weight - ожидание веса от пользователя
- Используйте state.update_data() для сохранения данных
- Очищайте состояние после завершения обработки

## Обработка фото:
- Скачивание файла с максимальным разрешением
- Сохранение во временную директорию
- Удаление после обработки
- Валидация существования файла

## Обработка текста:
- Проверка на наличие недавнего анализа для редактирования
- Валидация числового ввода для веса (1-5000 грамм)
- Предложение отправить фото если нет анализа

## Кнопки и клавиатуры:
- Используйте InlineKeyboardMarkup для кнопок
- Обрабатывайте callback_query для кнопок
- Предоставляйте понятные варианты действий

## Форматирование ответов:
- Используйте эмодзи для лучшего восприятия
- Применяйте Markdown форматирование с обработкой ошибок
- Используйте format_nutrition_info() для красивого отображения

## Регистрация обработчиков:
- Используйте функцию register_handlers(dp)
- Включайте роутеры через dp.include_router()
- Группируйте связанные обработчики в одном роутере